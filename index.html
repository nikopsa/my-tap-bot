<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fenix Tap</title>
    <script src="https://telegram.org"></script>
    <style>
        body { 
            background: radial-gradient(circle, #2c3e50, #000); 
            color: gold; 
            text-align: center; 
            font-family: sans-serif; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden;
        }
        #score { 
            font-size: 60px; 
            font-weight: bold; 
            margin-bottom: 20px; 
            text-shadow: 0 0 20px gold; 
        }
        .coin { 
            width: 220px; 
            height: 220px; 
            background: linear-gradient(45deg, #f1c40f, #f39c12); 
            border-radius: 50%; 
            border: 10px solid #d35400; 
            font-size: 80px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer; 
            user-select: none; 
            transition: transform 0.05s;
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.5);
        }
        .coin:active { transform: scale(0.92); }
        .label { margin-top: 20px; letter-spacing: 2px; color: white; opacity: 0.7; }
    </style>
</head>
<body>

    <div id="score">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="coin" id="coin" onclick="handleTap()">üî•</div>
    <div class="label">FENIX TAPPER</div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand(); 

        let userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 12345;
        let count = 0;
        const scoreElement = document.getElementById('score');

        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á–µ—Ç –∏–∑ –±–∞–∑—ã –ø—Ä–∏ –≤—Ö–æ–¥–µ
        fetch(`/get_user/${userId}`)
            .then(res => res.json())
            .then(data => {
                count = data.score || 0;
                scoreElement.innerText = count;
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
                scoreElement.innerText = 0;
            });

        // 2. –§—É–Ω–∫—Ü–∏—è —Ç–∞–ø–∞
        function handleTap() {
            count++;
            scoreElement.innerText = count;
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –∫–∞–∂–¥—ã–µ 5 –∫–ª–∏–∫–æ–≤
            if (count % 5 === 0) { 
                saveScore(); 
            }
        }

        // 3. –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        function saveScore() {
            fetch('/update_score', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_id: userId, score: count})
            });
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∏–ª–∏ —Å–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.onEvent('viewportChanged', saveScore);
        window.addEventListener('beforeunload', saveScore);
    </script>
</body>
</html>
